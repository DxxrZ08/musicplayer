<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MusicStream — Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-slate-900 text-slate-100">
  <div class="app-shell">
    <aside class="sidebar">
      <div class="logo">
        <img src="https://via.placeholder.com/40/1DB954/ffffff?text=M" width="40" height="40" style="border-radius:6px;" alt="logo">
        <div>
          <div class="fw-bold">MusicStream</div>
          <div class="small muted">Your music, everywhere</div>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="browse.html">Browse</a>
        <a href="library.html">Library</a>
        <a href="playlist.html">Playlists</a>
        <a href="profile.html" class="active">Profile</a>
      </nav>
      <div style="flex:1"></div>
      <div class="small muted">© MusicStream</div>
    </aside>

    <main class="main">
      <div class="container py-5">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card glass p-3 text-center">
              <img id="profileAvatar" src="https://via.placeholder.com/120" class="rounded-circle mb-3" alt="avatar">
              <h4 id="profileName" class="fw-semibold">Demo User</h4>
              <div id="profileEmail" class="text-sm muted">demo@musicstream.test</div>
              <div class="mt-3"><button id="btnOpenProfileEdit" class="btn btn-outline-light btn-sm">Edit Profile</button></div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card glass p-3">
              <h5>Recently Played</h5>
              <div id="recentList" class="list-group mt-2"></div>
              <hr>
              <h5>Preferences</h5>
              <div class="small muted">Preferred languages, genres, and recommendations (demo).</div>
            </div>
          </div>
        </div>
      </div>
    </main>

  <div class="player-fixed" id="player">
    <div class="container d-flex align-items-center gap-3">
      <img id="playerCover" src="https://via.placeholder.com/64" width="64" height="64" alt="cover">
      <div class="flex-grow-1">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div id="playerTitle" class="fw-semibold">Not playing</div>
            <div id="playerArtist" class="text-sm muted">—</div>
          </div>
          <div class="controls">
            <button class="btn btn-light" id="btnPrev">⏮</button>
            <button class="big-play" id="btnPlay">▶</button>
            <button class="btn btn-light" id="btnNext">⏭</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/dbstore.js"></script>
  <script src="js/main.js"></script>
  <script src="js/admin.js"></script>
  <script src="admin-inject.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    
    (function(){
      const modalHtml = `
      <div class="modal fade" id="profileEditModal" tabindex="-1">
        <div class="modal-dialog modal-md modal-dialog-centered">
          <div class="modal-content bg-dark text-light p-3">
            <div class="modal-header border-0"><h5 class="modal-title">Edit Profile</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <div class="mb-2"><label class="form-label small">Display name</label><input id="editName" class="form-control"></div>
              <div class="mb-2"><label class="form-label small">Email</label><input id="editEmail" class="form-control" type="email"></div>
              <div class="mb-2"><label class="form-label small">Avatar URL (optional)</label><input id="editAvatarUrl" class="form-control" placeholder="https://..."></div>
            </div>
            <div class="modal-footer border-0"><button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button><button id="saveProfileBtn" class="btn btn-primary">Save</button></div>
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    })();

    (function(){
      function waitForSongs(timeout=3000){
        return new Promise((resolve)=>{
          const t0 = Date.now();
          (function poll(){
            if(window.songsDB && window.songsDB.length>0) return resolve(true);
            if(Date.now()-t0 > timeout) return resolve(false);
            setTimeout(poll, 80);
          })();
        });
      }

      async function initProfile(){
        const raw = sessionStorage.getItem('userLoggedIn');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const avatar = document.getElementById('profileAvatar');
        if(!raw){
          if(profileName) profileName.innerText = 'Guest';
          if(profileEmail) profileEmail.innerText = 'Not logged in';
        } else {
          let user = null;
          try{ user = JSON.parse(raw); }catch(e){ user = null; }
          if(user){
            if(profileName) profileName.innerText = user.name || user.email;
            if(profileEmail) profileEmail.innerText = user.email || '';
            if(avatar){
              if(user.avatarUrl) avatar.src = user.avatarUrl;
              else if(window.generateInitialsAvatar) avatar.src = window.generateInitialsAvatar(user.name || user.email, 120);
            }
          }
        }

        // populate recent listens
        await waitForSongs(4000);
        const recentList = document.getElementById('recentList');
        if(!recentList) return;
        recentList.innerHTML = '';
        let recentIds = [];
        try{ recentIds = JSON.parse(sessionStorage.getItem('recentlyPlayed')||'[]'); }catch(e){ recentIds = []; }
        const items = recentIds.length ? recentIds.map(id=> window.songsDB.find(s=>s.id===id)).filter(Boolean) : window.songsDB.slice(0,5);
        items.forEach(s=>{
          const el = document.createElement('button');
          el.className = 'list-group-item list-group-item-action bg-transparent d-flex align-items-center gap-3';
          el.innerHTML = `<img src="${s.cover}" width="56" height="56" class="rounded"> <div class="flex-grow-1 text-start"><div class="fw-semibold">${s.title}</div><div class="small text-slate-400">${s.artist}</div></div>`;
          el.addEventListener('click', ()=>{ const idx = window.songsDB.findIndex(x=>x.id===s.id); if(idx>=0) playIndex(idx); });
          recentList.appendChild(el);
        });

        // wire edit button
        const editBtn = document.getElementById('btnOpenProfileEdit');
        editBtn && editBtn.addEventListener('click', ()=>{
          const raw2 = sessionStorage.getItem('userLoggedIn');
          let user = raw2 ? JSON.parse(raw2) : { email:'', name:'' };
          document.getElementById('editName').value = user.name || '';
          document.getElementById('editEmail').value = user.email || '';
          document.getElementById('editAvatarUrl').value = user.avatarUrl || '';
          const m = new bootstrap.Modal(document.getElementById('profileEditModal'));
          m.show();
        });

        // save handler
        document.getElementById('saveProfileBtn').addEventListener('click', ()=>{
          const name = (document.getElementById('editName').value||'').trim();
          const email = (document.getElementById('editEmail').value||'').trim();
          const avatarUrl = (document.getElementById('editAvatarUrl').value||'').trim() || null;
          if(!email){ uiToast('Email required', {type:'warning'}); return; }
          try{
            const users = JSON.parse(localStorage.getItem('mb_users')||'[]');
            const idx = users.findIndex(u=>u.email===email);
            const userObj = { email, name, avatarUrl };
            if(idx>=0){ users[idx] = Object.assign(users[idx], userObj); }
            else { users.push(userObj); }
            localStorage.setItem('mb_users', JSON.stringify(users));
            sessionStorage.setItem('userLoggedIn', JSON.stringify({ email, name, avatarUrl }));
            uiToast('Profile saved', {type:'success'});
            if(document.getElementById('profileName')) document.getElementById('profileName').innerText = name || email;
            if(document.getElementById('profileEmail')) document.getElementById('profileEmail').innerText = email;
            const avatar = document.getElementById('profileAvatar');
            if(avatar){ if(avatarUrl) avatar.src = avatarUrl; else if(window.generateInitialsAvatar) avatar.src = window.generateInitialsAvatar(name||email, 120); }
            bootstrap.Modal.getInstance(document.getElementById('profileEditModal')).hide();
          }catch(e){ console.error(e); uiToast('Save failed',{type:'danger'}); }
        });
      }
      document.addEventListener('DOMContentLoaded', initProfile);
    })();
  </script>
</body>
</html>
